# ZYF Auto-Crop - ComfyUI 人物智能裁剪插件

ComfyUI 的智能人物裁剪插件，支持自动检测人脸和身体，采用"人脸优先、身体为辅"的裁剪策略始终保持人脸在你选择的任何比例尺寸内！并不是以人脸为中心裁剪而是确保人脸完整的出现在最终图像上，根据所选比列最大化显示身体！如果检测不到人脸人物则按常规裁剪方式！首次运行1-2秒后面平均0.6秒
<img width="1662" height="874" alt="41c844b9edbe4d43" src="https://github.com/user-attachments/assets/1aa3072a-95b5-4820-ba12-461f0d0a48a3" />

## 功能特点
 
### 1. ZYF(按人物主体)比例缩放(2)节点
- **设备选择**：支持 `cpu/cuda`，默认 `cpu`，降低显存占用并在推理后自动释放显存
- **模型选择与自动下载**：可选择人脸/人物模型，缺失时自动从 `hf-mirror.com` 或 `huggingface.co` 下载到 ComfyUI 目录
- **灵活的宽高比**：支持多种预设宽高比（原始、1:1、3:2、4:3、16:9、2:3、3:4、9:16）或自定义比例
- **精确的尺寸控制**：
  - 缩放到边：支持最长边、最短边、宽度、高度、总像素(千像素)
  - 倍数取整：向上取整到指定倍数（8/16/32/64/128/256/512/无）
- **高质量缩放**：支持多种采样方法（lanczos、nearest、bilinear、bicubic）
- **多人物支持**：可选择裁剪第几个人物（按面积排序）
- **遮罩处理**：
  - 有输入遮罩：与图像同裁剪、同缩放（适应模式生成 letterbox 遮罩）
  - 无输入遮罩：输出全黑遮罩（0）
- **输出端口**：
  - 图像：裁剪后的图像
  - 遮罩：对应的遮罩
 
### 2. ZYF(按人物主体)比例缩放节点
- **智能人物检测**：自动检测人脸和身体，采用"人脸优先、身体次之"的裁剪策略
- **灵活的宽高比**：支持多种预设宽高比（原始、1:1、3:2、4:3、16:9、2:3、3:4、9:16）或自定义比例
- **精确的尺寸控制**：
  - 缩放到边：支持最长边、最短边、宽度、高度、总像素等多种缩放方式
  - 倍数取整：向上取整到指定倍数（8/16/32/64/128/256/512），适配AI模型需求
- **高质量缩放**：支持多种采样方法（lanczos、nearest、bilinear、bicubic）
- **多人物支持**：可选择裁剪第几个人物（按面积排序）
- **输出端口**：
  - 图像：裁剪后的图像
  - 遮罩：对应的遮罩

### 2. ZYF自动裁剪边框节点
- **智能边框检测**：自动检测并裁剪图像四周的纯色边框
- **可调容差**：支持设置颜色容差值，灵活控制裁剪范围
- **安全裁剪**：设置最小裁剪尺寸，防止过度裁剪
- **输入端口**：
  - 图像：输入图像
  - 遮罩（可选）：输入遮罩
- **输出端口**：
  - 图像：裁剪后的图像
  - 遮罩：对应的遮罩

## 安装方法

1. 将本插件文件夹放入 ComfyUI 的 `custom_nodes` 目录
2. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
3. 模型会在首次使用时自动下载（无需手动下载）

## 使用的模型

本插件使用以下 YOLOv8 模型：

### 1. 人脸检测模型
- **文件名**: `face_yolov8m.pt`
- **本地路径**: `ComfyUI/models/ultralytics/bbox/face_yolov8m.pt`
- **来源**: [Bingsu/adetailer](https://huggingface.co/Bingsu/adetailer)
- **自动下载**: 优先从 hf-mirror.com 下载，失败则从 huggingface.co 下载

### 2. 身体检测模型
- **文件名**: `person_yolov8m-seg.pt`
- **本地路径**: `ComfyUI/models/ultralytics/segm/person_yolov8m-seg.pt`
- **来源**: [Bingsu/adetailer](https://huggingface.co/Bingsu/adetailer)
- **自动下载**: 优先从 hf-mirror.com 下载，失败则从 huggingface.co 下载

**注意**: 
- 首次使用时，插件会自动检测模型是否存在
- 如果模型不存在，会自动从 Hugging Face 下载（优先使用国内镜像）
- 下载过程会显示进度信息
- 如果自动下载失败，可以手动下载模型并放置到对应路径

## 使用说明

### ZYF(按人物主体)比例缩放节点

**输入参数：**
- **图像**：输入图像
- **遮罩**（可选）：输入遮罩
- **宽高比**：目标宽高比选择（默认"原始"）
- **比例宽/高**：自定义宽高比的值（仅当选择"自定义"时生效）
- **缩放模式**：适应/裁剪/填充（默认"适应"）
- **采样方法**：lanczos/nearest/bilinear/bicubic（默认"lanczos"）
- **倍数取整**：8/16/32/64/128/256/512/无（默认"16"）
- **缩放到边**：无/最长边/最短边/宽度/高度/总像素（默认"无"）
- **缩放到长度**：目标边的像素长度（默认1024）
- **背景颜色**：十六进制颜色代码（默认"#000000"）
- **人物索引**：选择第几个人物（默认0，即最大的人物）

**输出：**
- 图像：裁剪后的图像
- 遮罩：对应的遮罩

**裁剪策略：**
1. 检测人脸和身体
2. 最大化显示人物主体部分（移除“人脸至少 2/3 可见”限制）
3. 如果指定了宽高比，严格按照宽高比裁剪
4. 检测失败或异常时，按“适应/裁剪/填充”回退到传统中心裁剪/letterbox（不强制拉伸，除非选择“填充”）
5. 遮罩规则：
   - 有输入遮罩：与图像同裁剪/缩放（适应模式生成 letterbox 遮罩）
   - 无输入遮罩：输出全黑遮罩（0）

**注意：** 本节点采用"最大化人物主体显示"策略，会自动找到最大的裁剪区域，因此不提供边距参数。

### ZYF自动裁剪边框节点

**输入参数：**
- **图像**：输入图像
- **遮罩**（可选）：输入遮罩
- **容差值**：颜色容差值（0-255，默认10）
- **最小裁剪尺寸**：最小裁剪尺寸（默认10）

**输出：**
- 图像：裁剪后的图像
- 遮罩：对应的遮罩

## 技术细节

### 核心文件
- `nodes.py`：节点定义和主要逻辑
- `detection_manager.py`：人脸和身体检测管理
- `crop_calculator.py`：裁剪区域计算
- `image_processor.py`：图像处理工具
- `models.py`：数据模型定义

### 依赖项
- PyTorch
- ultralytics（YOLOv8）
- Pillow
- NumPy

## 示例工作流
 
参考 `example_workflow.json` 文件，包含：
- 使用 `ZYFPersonCropAdvanced` 节点对图片进行智能裁剪并保存
- 使用 `ZYFAutoCropBorder` 节点裁剪纯色边框并保存

## 更新日志
 
### v1.1.0
- 新增“ZYF(按人物主体)比例缩放(2)”节点（设备与模型选择、自动下载）
- 默认设备设为 CPU；推理后移回 CPU 以释放显存
- 取消人脸 2/3 可见度限制；检测失败回退到中心裁剪/letterbox
- 遮罩规则更新：无输入遮罩时输出全黑；有遮罩时同步裁剪/缩放
 
### v1.0.0
- 初始版本发布
- 支持人物主体智能裁剪
- 支持自动裁剪边框
- 完整的宽高比控制
- 多种缩放和取整选项
- 遮罩和尺寸输出

## 许可证

MIT License

## 作者

ZYF

## 反馈与支持

如有问题或建议，请提交 Issue。
